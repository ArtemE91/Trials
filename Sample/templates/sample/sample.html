{% extends 'index.html' %}

{% block title %}
    Sample
{% endblock %}

{% block search %}
    {% include 'sample/includes/search.html' %}
{% endblock %}

{% block content %}
    {% include 'sample/includes/table.html' %}

    <div class="ui orange segment" id="id_segment_select_table">
        <div class="ui grid">
            <div class="six wide column">
                <h3 class="ui header">Таблица выбранных образцов</h3>
            </div>
            <div class="ten wide column">
                <button class="ui button disabled" id="id_btn_detail_sample"  style="display: none;">
                    <i class="exclamation icon"></i>
                    Детально
                </button>
            </div>
        </div>
        <div class="ui visible info message" id="id_message_table_select">
            <p>Здесь будут отображаться выбранные вами образцы!</p>
        </div>
        <br>
        <div class="sixteen wide column">
                <div class="select table">
                    <table hidden class="ui celled striped table green compact selectable" style="width:100%" id="sample_table_select">
                        <thead>
                        <tr>
                            <th>Материал</th>
                            <th>Маркировка</th>
                            <th>Способ упрочнения</th>
                            <th>Толщина покрытия</th>
                            <th>Шероховатость поверхности</th>
                            <th>Твердость покрытия</th>
                            <th>Состав покрытия</th>
                            <th>
                                <div class="ui checkbox all" id="id_checkbox_all_select">
                                    <input type="checkbox" name="checkbox_all_select">
                                    <label></label>
                                </div>
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>

const select_sample = []; // Выбранные элементы в таблице sample_table
const check_sample = []; // Выбранные элементы в таблице sample_table_select

function show_select_table() {
    if (select_sample.length > 0){
        $('#id_btn_detail_sample').removeAttr('style');
        $('#sample_table_select').removeAttr('hidden');
        $('#id_message_table_select').attr('style', 'display: none');

    }
    else {
        $('#id_btn_detail_sample').attr('style', 'display: none');
        $('#sample_table_select').attr('hidden', 'display: none');
        $('#id_message_table_select').removeAttr('style');
    }
}


// Функция для подсвечивания выбранной строки
function check_select_tr(action, sample_id){
    if (action === 'check') {
        $('#tr_select_' + sample_id).attr('class', 'green');
        $('#select_checkbox_' + sample_id).checkbox('set checked');
        check_sample.push(sample_id);
    }
    else {
        $('#tr_select_' + sample_id).removeAttr('class');
        $('#select_checkbox_' + sample_id).checkbox('set unchecked');
        check_sample.splice(check_sample.indexOf(sample_id), 1);
    }
}

// Функция сравнения массивов, возращает элементы которых нет во 2 массиве
function diff(a1, a2) {
    return a1.filter(i=>!a2.includes(i))
    .concat(a2.filter(i=>!a1.includes(i)))
}

// Обработка checkbox в шапке таблицы sample_table_select
$('#id_btn_detail_sample')
    .on('click', function () {
        $('#id_segment_select_table').append(dimmer);
        let trial_id = $('#tr_select_' + check_sample[0]).attr('name').slice('id_trials_'.length);
        if (trial_id){
            ajax_get_graph(trial_id, check_sample[0]);
        }else {
            let message = $('<div class="ui message info visible">\n' +
                '        <div class="ui text">У данного образца нет испытаний!</div>\n' +
                '    </div>')
            ajax_get_detail_sample(check_sample[0], message);
        }

    })

$('.ui.checkbox.all')
    .checkbox({
        onChecked: function(){
            // Если выбранных элементов sample_table_select нет то делаем их все активными
            if (check_sample.length === 0) {
                for (let sample_id of select_sample) {
                    check_select_tr('check', sample_id);
                }
            }
            else { // Делаем активными только те которые еще не были выбраны
                let uncheck_sample = diff(select_sample, check_sample);
                for (let sample_id of uncheck_sample) {
                    check_select_tr('check', sample_id);
                }
            }
        },
        // Будет активным только если все элементы в таблице sample_table_select выбраны
        onUnchecked: function(){
            // Убираем подсветку всем выбранным элементам
            if (check_sample.length === select_sample.length) {
                for (let sample_id of select_sample) {
                    check_select_tr('uncheck', sample_id);
                }
            }
        }
    })

    // Функция проверяет был ли это элемент уже выбран
    function check_select_sample(id){
        const index = check_sample.indexOf(id);
        return index <= -1;
    }

    function change_select_sample(id){
        const index = select_sample.indexOf(id);
        if (index > -1){
            select_sample.splice(index, 1);
        }
        else{
            select_sample.push(id);
        }
    }

    function ajax_get_graph(trial_id, sample_id){
        // Реализовать проверку если trial_id отсутствует
        $.ajax({
            type: 'GET',
            url: '/trial/' + trial_id + '/get_graph',
            success: function (response) {
                ajax_get_detail_sample(sample_id, $(response))
            }
        })
    }

    function ajax_get_detail_sample(sample_id, graph){
        $.ajax({
            type: 'GET',
            url: '/sample/detail/' + sample_id,
            success: function (response) {
                let modal = $(response);
                modal.find('#id_graph').append(graph);
                modal.modal('show');
                $('#id_dimmer_sample').remove()
            }
        });
    }


</script>

{% endblock %}