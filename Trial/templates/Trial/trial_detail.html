{% extends 'index.html' %}
{% load static %}


{% block content %}
<div class="ui orange clearing segment" style="margin-top: 55px;">
    <h3 class="ui dividing header">Испытание {{ trials.pk }}</h3>
    <div class="ui list">
        <div class="item">
            <div class="ui grid">
                <div class="three wide column">Размер частиц:</div>
                <div class="thirteen wide column">{{ trials.size_particle }}</div>
            </div>
        </div>
        <div class="item">
            <div class="ui grid">
                <div class="three wide column">Скорость соударения:</div>
                <div class="thirteen wide column">{{ trials.speed_collision }}</div>
            </div>
        </div>
        <div class="item">
            <div class="ui grid">
                <div class="three wide column">Дополнительные параметры:</div>
                <div class="thirteen wide column">{{ trials.add_param }}</div>
            </div>
        </div>
        <div class="item">
            <div class="ui grid">
                <div class="three wide column">Угол соударения:</div>
                <div class="thirteen wide column">{{ trials.corner_collision }}</div>
            </div>
        </div>
        <div class="item">
            <div class="ui grid">
                <div class="three wide column">Дата начала испытаний:</div>
                <div class="thirteen wide column">{{ trials.date_trials }}</div>
            </div>
        </div>
        <div class="item">
            <div class="ui grid">
                <div class="three wide column">Дата окончания испытаний:</div>
                <div class="thirteen wide column">{{ trials.date_end_trials }}</div>
            </div>
        </div>
        <div class="item">
            <div class="ui grid">
                <div class="three wide column">Тип частиц:</div>
                <div class="thirteen wide column">{{ trials.type_particle }}</div>
            </div>
        </div>
        <div class="item">
            <div class="ui grid">
                <div class="three wide column">Описание:</div>
                <div class="thirteen wide column">{{ trials.description }}</div>
            </div>
        </div>
        <div class="item">
            <div class="ui grid">
                <div class="three wide column">Образец:</div>
                <div class="thirteen wide column">{{ trials.sample }}</div>
            </div>
        </div>
        <br>
        <form action="{% url 'trial:update' trials.pk %}">
            <button class="ui right floated button">Изменить</button>
        </form>
    </div>  
</div>

<div class="ui orange clearing segment">
    <h3 class="ui dividing header">Эксперементы</h3>
    <div class="sixteen wide column">
        <div class="select table">
            <table class="ui celled striped table green compact selectable" id="experiments_table">
                <thead>
                    <tr>
                        <th>Изменение массы за время испытания</th>
                        <th>Время испытания</th>
                        <th>Изображение</th>
                    </tr>
                </thead>
                <tbody id='experiments_table_body'>
                    {% for experiment in trials.trials_values.all %}
                    <tr id='{{ experiment.pk }}'>
                        <td>{{ experiment.change_weight }}</td>
                        <td>{{ experiment.time_trials }}</td>
                        <td>{{ experiment.image }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <br>
    <div class="field">
        <div class="ui button right floated positive material">Создать</div>
    </div>

    <div class="ui teal left floated buttons">
        <div class="ui button" id='experiment_action_btn'><i class="edit icon"></i>Изменить</div>
        <div class="ui combo top right pointing dropdown icon button">
            <i class="dropdown icon"></i>
            <div class="menu">
                <div class="item"><i class="edit icon"></i>Изменить</div>
                <div class="item"><i class="delete icon"></i>Удалить</div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>

var token = '{{csrf_token}}';

$('.combo.dropdown')
  .dropdown({
    action: 'combo'
  })
;

function ajax_update_experement_table(){ // Получаю список эксперементов, текущего испытания. Переписываю tbody в таблице эксперементов
    $.ajax({
        url: 'experement_list/',  // <int:pk>/experement_list/ - url где pk это primary key от Trial
        type: 'get',
        success: function(data){
            $('#experiments_table_body').html(data); // Переписываю содержимое tbody 
            window.onload = addRowHandlers();
        }
    });
};

$('#experiment_action_btn').click(function () { // создаю модальное окно, с формой для создания эксперемента
    let btn_text = this.innerText;
    if (btn_text=='Удалить'){
        $.ajax({
            headers: { "X-CSRFToken": token },
            url: "{% url 'trial:delete_experiment' 0 %}".replace(0, checked_experement_pk),
            type: 'post',
            success: function(data)
            { // Получили форму модального окна
                ajax_update_experement_table();
            }
        });
    }
    else if(btn_text=="Изменить"){
        alert("Изменить");
    }
});

$('.ui.button.positive.material').click(function () { // создаю модальное окно, с формой для создания эксперемента
    $.ajax({
        url: '{% url 'trial:create_experiment' %}',
        type: 'get',
        success: function(data)
        { // Получили форму модального окна
            $(data).modal().modal('show');
        }
    });
});

var checked_experement_pk=null;

function addRowHandlers() {
    var table = document.getElementById("experiments_table");
    var rows = table.getElementsByTagName("tr");
    for (i = 0; i < rows.length; i++) {
        var currentRow = table.rows[i];
        var createClickHandler = 
            function(row){
                return function() {
                    if (checked_experement_pk==row.id){
                        $(`#${checked_experement_pk}`).removeAttr('class');
                        }
                    else{
                        $(`#${checked_experement_pk}`).removeAttr('class');
                        $(`#${row.id}`).attr('class', 'green');
                        }
                        checked_experement_pk=row.id;
                    };
            };
        currentRow.onclick = createClickHandler(currentRow);
    }
}
window.onload = addRowHandlers();
</script>
{% endblock scripts %}
