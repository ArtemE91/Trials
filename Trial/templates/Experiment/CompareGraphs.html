{% extends 'index.html' %}

{% block content %}
    <div class="ui orange segment" style='margin-top: 55px;'>

        <!-- <input disabled id="sample_ids" style="display: none"
               value="{% for id in sample_ids %}{{ id }} {% endfor %}"> -->

        <div id="myPlot" style="width: 100%; height: 100%;">
        </div>

        <div class="ui message answer" style="display: none;">
            <div class="header" id="header_answer">
            </div>
            <div id="answer">
            </div>
        </div>

        <div class="ui negative message" style="display: none;">
           <div class="ui text">Для выбранных образцов нет экспериментов</div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>


    var myPlot = document.getElementById("myPlot")
    var layout = { hovermode:'closest', title:'Выбранные эксперименты'};

    var list_trace = []

    function forming_data(data){
        for (let name_trace in data){
            let trace = {type: 'scatter'}
            trace['name'] = name_trace;
            for (let name_field in data[name_trace]){
                if (name_field === 'weight'){
                    trace['y'] = data[name_trace][name_field]
                }
                if (name_field === 'times'){
                    trace['x'] = data[name_trace][name_field]
                }
            }
            list_trace.push(trace)
        }
    }

    function point_comparison(standard_point){
        // Перебираем элементы и получаем y в точке x_standard_point только не эталоных элементов
        // Затем производим расчеты по полученным y с y_standard_point
        let answer = {'header': '', 'body': ''}
        let y_other_point = {}
        for (let trace of list_trace){
           if(trace['name'] !== standard_point.data['name']){
               y_other_point[trace['name']] = trace['y'][trace['x'].indexOf(standard_point['x'])]
           }
        }

        answer['header'] = 'За эталон выбран образец ' + standard_point.data['name'] +
            ', Время = ' + standard_point['x'] + '\n'

        for (let name_trace in y_other_point){
            let y_ratio = (standard_point['y']/y_other_point[name_trace]).toFixed(2);
            let line = 'Стойкость образца ' + name_trace
            if (y_ratio > 1){
                line += ' лучше на ' + Math.round((y_ratio - 1) * 100) + '%'
            } else if (y_ratio === 1) {
                line += ' равна стойкости эталонного образца'
            } else {
                line += ' хуже на ' + Math.round((1 - y_ratio) * 100) + '%'
            }
            answer['body'] += line + '<br>'
        }
        return answer;
    }

    function show_message(message){
        $('#header_answer').text(message['header']);
        $('#answer').html(message['body']);
        $('.ui.message.answer').attr('style', '');
    }

    var isEmptyObject = function (obj) { return Object.keys(obj).length === 0; };

    function ajax_get_list_graph(){
        let ids = {{ sample_ids|safe }};
        let query_params = jQuery.param({'samples': ids});
        $.ajax({
            type: 'GET',
            url: "{% url 'trial:compare_graphs_list' %}?"+query_params,
            success: function (response) {
                if (isEmptyObject(response)){
                    $('.ui.negative.message').attr('style', '');
                }
                else {
                    forming_data(response);
                    Plotly.newPlot(myPlot, list_trace, layout)
                    myPlot.on('plotly_click', function (data) {
                        let answer = point_comparison(data.points[0]);
                            show_message(answer);
                    });
                }
            }
        })
    }

    ajax_get_list_graph();


    // Для изменения цвета необходимо устанавливать аттрибут markers
        {# let pn = standard_point.pointNumber;#}
        {#let tn = standard_point.curveNumber;#}
        {#let colors=[];#}
        {#let size=[];#}
        {#console.log(standard_point);#}
        {#colors = standard_point.fullData.marker.color;#}
        {#console.log(colors)#}
        {#size = standard_point.fullData.marker.size;#}
        {#colors[pn] = '#c54c82';#}
        {#size[pn] = 10;#}
        {##}
        {#var update = {'marker':{color: colors, size: size}};#}
        {#Plotly.restyle(myPlot, update, [tn]);#}


    </script>
{% endblock %}