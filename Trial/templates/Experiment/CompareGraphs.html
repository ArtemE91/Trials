{% extends 'index.html' %}

{% block content %}
    <div class="ui orange segment" style='margin-top: 55px;'>

        <div id="myPlot" style="width: 100%; height: 100%;"></div>

        <select class="ui dropdown compact" id="action_type">
            <option value="">Действие по клику</option>
            <option value="point_comparison">Сравнение</option>
            <option value="make_tangent">Касательные</option>
          </select>
          
        <div class="ui message answer" style="display: none;">
            <div class="header" id="header_answer">
            </div>
            <div id="answer">
            </div>
        </div>

        <div class="ui negative message" style="display: none;">
           <div class="ui text">Для выбранных образцов нет экспериментов</div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
var clickHandler=point_comparison;
$('#action_type')
.dropdown({
    onChange: function(value, text, $selectedItem) {
        clickHandler=window[value];
    }
  })
;

    var myPlot = document.getElementById("myPlot")
    var layout = { hovermode:'closest', title:'Выбранные эксперименты'};

    var list_trace = []

    function forming_data(plots_info){
        for (var i = 0; i < plots_info.length; i++){
            let plot = plots_info[i]
            let coordinates = plot['coordinates']
            let mode = 'lines+markers';
            if (coordinates.length > 1){ 
                mode = 'markers'}
            for (var c = 0; c < coordinates.length; c++){
                let coordinate = coordinates[c];
                trace = {
                    'x': coordinate[0],
                    'y': coordinate[1],
                    'name': coordinate[2],
                    'mode': mode
                };
                list_trace.push(trace);
            }
            
            let trend_name = 'poly_trend';
            if (trend_name in plot){
                trend_info = plot[trend_name];
                trend_trace = {
                    'x': trend_info[0],
                    'y': trend_info[1],
                    'name': trend_info[2],
                    'mode': 'lines'
                };
                list_trace.push(trend_trace);
            }
        }
    }

    function point_comparison(standard_point){
        // Перебираем элементы и получаем y в точке x_standard_point только не эталоных элементов
        // Затем производим расчеты по полученным y с y_standard_point
        let answer = {'header': '', 'body': ''}
        let y_other_point = {}
        for (let trace of list_trace){
           if(trace['name'] !== standard_point.data['name']){
               y_other_point[trace['name']] = trace['y'][trace['x'].indexOf(standard_point['x'])]
           }
        }

        answer['header'] = 'За эталон выбран образец ' + standard_point.data['name'] +
            ', Время = ' + standard_point['x'] + '\n'

        for (let name_trace in y_other_point){
            let y_ratio = (standard_point['y']/y_other_point[name_trace]).toFixed(2);
            let line = 'Стойкость образца ' + name_trace
            if (y_ratio > 1){
                line += ' лучше на ' + Math.round((y_ratio - 1) * 100) + '%'
            } else if (y_ratio === 1) {
                line += ' равна стойкости эталонного образца'
            } else {
                line += ' хуже на ' + Math.round((1 - y_ratio) * 100) + '%'
            }
            answer['body'] += line + '<br>'
        }
        show_message(answer);;
    }

    var tangent_trace = {x: [], y :[], type: 'scatter', mode: 'lines', showlegend: false,
                          line: {color: 'rgb(0, 0, 0)', width: 1}};
    function make_tangent(point){
        tangent_trace['x'].push(point['x']);
        tangent_trace['y'].push(point['y']);
        // 2 клика в одну точку очистят список координат
        if (tangent_trace['x'][0]==tangent_trace['x'][1] && tangent_trace['y'][0]==tangent_trace['y'][1]){
            tangent_trace['x']=[];
            tangent_trace['y']=[];
        }
        if (tangent_trace['x'].length == 2){
            tangent_trace['x'].push(calc_x0(tangent_trace));
            tangent_trace['y'].push(0);
            Plotly.addTraces(myPlot, tangent_trace);
            tangent_trace['x']=[];
            tangent_trace['y']=[];
        }
    }

    function calc_x0(tangent_trace){ //расчет пересечения прмой с 0Х
        let x1=tangent_trace['x'][0];
        let x2=tangent_trace['x'][1];
        let y1=tangent_trace['y'][0];
        let y2=tangent_trace['y'][1];
        let x = -y1*(x2-x1)/(y2-y1)+x1; // Уравнение прямой проходящей через 2 точки
        return x;
    }

    function show_message(message){
        $('#header_answer').text(message['header']);
        $('#answer').html(message['body']);
        $('.ui.message.answer').attr('style', '');
    }

    var isEmptyObject = function (obj) { return Object.keys(obj).length === 0; };

    function ajax_get_list_graph(){
        let ids = {{ sample_ids|safe }};
        let query_params = jQuery.param({'samples': ids});
        $.ajax({
            type: 'GET',
            url: "{% url 'trial:compare_graphs_list' %}?"+query_params,
            success: function (response) {
                if (isEmptyObject(response)){
                    $('.ui.negative.message').attr('style', '');
                }
                else {
                    forming_data(response['data']);
                    //forming_data(response);
                    Plotly.newPlot(myPlot, list_trace, layout)
                    myPlot.on('plotly_click', function (data) {
                        clickHandler(data.points[0]);
                    });
                }
            }
        })
    }
    ajax_get_list_graph();


    // Для изменения цвета необходимо устанавливать аттрибут markers
        {# let pn = standard_point.pointNumber;#}
        {#let tn = standard_point.curveNumber;#}
        {#let colors=[];#}
        {#let size=[];#}
        {#console.log(standard_point);#}
        {#colors = standard_point.fullData.marker.color;#}
        {#console.log(colors)#}
        {#size = standard_point.fullData.marker.size;#}
        {#colors[pn] = '#c54c82';#}
        {#size[pn] = 10;#}
        {##}
        {#var update = {'marker':{color: colors, size: size}};#}
        {#Plotly.restyle(myPlot, update, [tn]);#}


    </script>
{% endblock %}