{% extends 'index.html' %}

{% block content %}
    <div class="ui orange segment" style='margin-top: 55px;'>

        <div id="myPlot" style="width: 100%; height: 100%;"></div>

        <select class="ui dropdown compact" id="action_type">
            <option value="">Действие по клику</option>
            <option value="point_comparison">Сравнение</option>
            <option value="make_tangent">Касательные</option>
        </select>

        <div class='ui segment'>
            <button class="ui labeled icon button" onclick="deleteTrace()">
                <i class="eraser icon"></i>
                Удалить касательную
            </button>
            <button class="ui labeled icon button" onclick="changePolynome()">
                <i class="shekel sign icon"></i>
                Другой полином
            </button>
        </div>

        <div class="ui message answer" style="display: none;">
            <div class="header" id="header_answer">
            </div>
            <div id="answer">
            </div>
        </div>

        <div class="ui negative message" style="display: none;">
           <div class="ui text">Для выбранных образцов нет экспериментов</div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
var clickHandler=point_comparison;
$('#action_type')
.dropdown({
    onChange: function(value, text, $selectedItem) {
        clickHandler=window[value];
    }
  })
;

function deleteTrace(){
    if (tangentCount>0) {
        Plotly.deleteTraces('myPlot', -1);
        tangentCount -= 1;
    }
};


    var myPlot = document.getElementById("myPlot")
    var layout = {hovermode:'closest', 
                  title:'Выбранные эксперименты', 
                  xaxis: {title: 
                    {text: "Изменение времени, мин"}
                  },
                  yaxis: {title: 
                    {text: "Изменение массы, г"}
                  }
                 };

    var list_trace = []
    var trend_ids;
    var showed_trend_group = 0;

    function point_comparison(standard_point){
        // Перебираем элементы и получаем y в точке x_standard_point только не эталоных элементов
        // Затем производ с y_standard_point
        let answer = {'header': '', 'body': ''}
        let y_other_point = {}
        for (let trace of list_trace){
           if(trace['name'] !== standard_point.data['name']){
               y_other_point[trace['name']] = trace['y'][trace['x'].indexOf(standard_point['x'])]
           }
        }

        answer['header'] = 'За эталон выбран образец ' + standard_point.data['name'] +
            ', Время = ' + standard_point['x'] + '\n'

        for (let name_trace in y_other_point){
            let y_ratio = (standard_point['y']/y_other_point[name_trace]).toFixed(2);
            let line = 'Стойкость образца ' + name_trace
            if (y_ratio > 1){
                line += ' лучше на ' + Math.round((y_ratio - 1) * 100) + '%'
            } else if (y_ratio === 1) {
                line += ' равна стойкости эталонного образца'
            } else {
                line += ' хуже на ' + Math.round((1 - y_ratio) * 100) + '%'
            }
            answer['body'] += line + '<br>'
        }
        show_message(answer);;
    }

    var tangentCount = 0
    var tangent_trace = {x: [], 
                         y :[], 
                         type: 'scatter', 
                         mode: 'lines+text', 
                         text: [], 
                         textfont: {
                         family: 'sans serif',
                         size: 20
                        //  color: '#ff7f0e'
                         },
                         textposition: 'bottom', 
                         showlegend: false,
                         line: {width: 4}};
    function make_tangent(point){
        tangent_trace['x'].push(point['x']);
        tangent_trace['y'].push(point['y']);
        // 2 клика в одну точку очистят список координат
        if (tangent_trace['x'][0]==tangent_trace['x'][1] && tangent_trace['y'][0]==tangent_trace['y'][1]){
            tangent_trace['x']=[];
            tangent_trace['y']=[];
        }
        if (tangent_trace['x'].length == 2){
            let x0 = calc_x0(tangent_trace)
            tangent_trace['x'].push(x0);
            tangent_trace['text'] = [, ,'Pinc='+Number((x0).toFixed(5))];
            tangent_trace['y'].push(0);
            Plotly.addTraces(myPlot, tangent_trace);
            tangentCount += 1;
            tangent_trace['x']=[];
            tangent_trace['y']=[];
        }
    }

    function calc_x0(tangent_trace){ //расчет пересечения прмой с 0Х
        let x1=tangent_trace['x'][0];
        let x2=tangent_trace['x'][1];
        let y1=tangent_trace['y'][0];
        let y2=tangent_trace['y'][1];
        let x = -y1*(x2-x1)/(y2-y1)+x1; // Уравнение прямой проходящей через 2 точки
        return x;
    }

    function show_message(message){
        $('#header_answer').text(message['header']);
        $('#answer').html(message['body']);
        $('.ui.message.answer').attr('style', '');
    }

    var isEmptyObject = function (obj) { return Object.keys(obj).length === 0; };

    function ajax_get_list_graph(){
        let ids = {{ sample_ids|safe }};
        let query_params = jQuery.param({'samples': ids});
        $.ajax({
            type: 'GET',
            url: "{% url 'trial:compare_graphs_list' %}?"+query_params,
            success: function (response) {
                if (isEmptyObject(response)){
                    $('.ui.negative.message').attr('style', '');
                }
                else {
                    list_trace = response['traces'];
                    trend_ids = response['trend_ids']
                    Plotly.newPlot(myPlot, list_trace, layout);
                    showTrendGroup(showed_trend_group);
                    myPlot.on('plotly_click', function (data) {
                        clickHandler(data.points[0]);
                    });
                }
            }
        })
    }
    ajax_get_list_graph();

    function showTrendGroup(group_id){        // group_id индекс группы которая будет отображаться
        let update_unvisible = {'visible': false};
        let update_visible = {'visible': true};
        for (i=0; i<trend_ids.length; i++){
            if (i==showed_trend_group){
                Plotly.restyle(myPlot, update_visible, trend_ids[i]);
                continue;
            };
            Plotly.restyle(myPlot, update_unvisible, trend_ids[i])
        }
    };

    function changePolynome(){
        showed_trend_group +=1;
        if (showed_trend_group==trend_ids.length){
            showed_trend_group=0;
        };
        showTrendGroup(showed_trend_group);
    };

    </script>
{% endblock %}